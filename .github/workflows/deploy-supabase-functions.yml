name: Deploy Supabase Edge Functions

on:
  push:
    branches:
      - main
    paths:
      - 'supabase/functions/**'

jobs:
  deploy-functions:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node (needed by some supabase CLI internals)
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Setup Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: 'latest'

      - name: Authenticate Supabase CLI
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
        run: |
          supabase login --token "$SUPABASE_ACCESS_TOKEN"

      - name: Deploy changed functions
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
        run: |
          # Option A: deploy all functions (fast for small number)
          supabase functions deploy --project-ref ${{ secrets.SUPABASE_PROJECT_REF }} --no-verify

          # Option B: deploy only changed functions (uncomment and adapt if you prefer)
          # git diff --name-only ${{ github.sha }} ${{ github.event.before }} | grep '^supabase/functions/' | cut -d'/' -f3 | sort -u | while read fn; do
          #   [ -z "$fn" ] && continue
          #   supabase functions deploy "$fn" --project-ref ${{ secrets.SUPABASE_PROJECT_REF }} --no-verify
          # done

      - name: Optional Trigger Vercel Deploy
        if: ${{ secrets.VERCEL_TOKEN != '' && secrets.VERCEL_PROJECT_ID != '' }}
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
        run: |
          echo "Triggering Vercel deployment..."
          curl -s -X POST "https://api.vercel.com/v13/deployments" \
            -H "Authorization: Bearer $VERCEL_TOKEN" \
            -H "Content-Type: application/json" \
            -d "{\"projectId\":\"$VERCEL_PROJECT_ID\",\"gitSource\":{\"type\":\"github\",\"repoId\":\"${{ github.repository }}\"}}"

      - name: Cleanup supabase login
        if: always()
        run: |
          supabase logout || true